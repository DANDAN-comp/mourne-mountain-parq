
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('questionnaireForm');
        const submitBtn = document.getElementById('submitBtn');
        const formSteps = document.querySelectorAll('.form-step');
        const nextBtns = document.querySelectorAll('.btn-next');
        const prevBtns = document.querySelectorAll('.btn-prev');
        const progressBar = document.getElementById('progressBar');
        const originalBtnHTML = submitBtn.innerHTML;
        let currentStep = 0;

        function showStep(index) {
            formSteps.forEach((step, i) => step.classList.toggle('d-none', i !== index));
            progressBar.style.width = `${((index + 1) / formSteps.length) * 100}%`;
            progressBar.innerText = `Step ${index + 1} of ${formSteps.length}`;
        }

        nextBtns.forEach(btn => btn.addEventListener('click', () => {
            if (currentStep < formSteps.length - 1) showStep(++currentStep);
        }));
        prevBtns.forEach(btn => btn.addEventListener('click', () => {
            if (currentStep > 0) showStep(--currentStep);
        }));
        showStep(currentStep);

        async function rasterizeImage(img) {
            return new Promise(resolve => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                img.crossOrigin = 'anonymous';
                const draw = () => {
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.complete && img.naturalWidth
                    ? draw()
                    : (img.onload = draw, img.onerror = () => resolve(null));
            });
        }

        async function rasterizeAllImages(container) {
            const imgs = container.querySelectorAll('img');
            for (const img of imgs) {
                const png = await rasterizeImage(img);
                if (png) img.src = png;
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
      <span class="spinner-border spinner-border-sm me-2" role="status"></span>
      Submitting...
    `;
            // show all steps
            formSteps.forEach(s => s.classList.remove('d-none'));
            progressBar.style.width = '100%';
            progressBar.textContent = `Step ${formSteps.length} of ${formSteps.length}`;
            await new Promise(r => setTimeout(r, 100));

            const name = document.getElementById('participantName').value.trim() || 'Participant';
            const date = document.getElementById('eventDate').value.trim() || 'Date';
            const card = form.closest('.card');
            const clone = card.cloneNode(true);

            // 1) CORS‚Äêenable images
            clone.querySelectorAll('img').forEach(img => img.crossOrigin = 'anonymous');
            // 2) Strip every CSS background‚Äêimage on the clone subtree
            clone.querySelectorAll('*').forEach(el => {
                el.style.backgroundImage = 'none';
            });
            clone.style.backgroundImage = 'none';
            // 3) Wrap it in a white container
            const wrapper = document.createElement('div');
            Object.assign(wrapper.style, {
                position: 'fixed',
                top: '-9999px',
                left: '0',
                opacity: '0',
                pointerEvents: 'none',
                background: '#fff'
            });
            wrapper.appendChild(clone);
            document.body.appendChild(wrapper);
            clone.style.background = '#fff';

            // 4) Rasterize all <img> to PNG data‚ÄêURLs
            await rasterizeAllImages(clone);

            // 5) Generate PDF
            const options = {
                margin: 0.5,
                filename: `${date}_${name}_PARQ.pdf`,
                image: {type: 'jpeg', quality: 0.98},
                html2canvas: {scale: 2, useCORS: true, backgroundColor: '#fff'},
                jsPDF: {unit: 'in', format: 'letter', orientation: 'portrait'}
            };

            try {
                const pdfBlob = await html2pdf().from(clone).set(options).outputPdf('blob');
                const formData = new FormData();
                formData.append('file', pdfBlob, `${date}_${name}_PARQ.pdf`);
                formData.append('filename', `${date}_${name}_PARQ.pdf`);
                formData.append('participantName', name);
                formData.append('eventDate', date);

                const res = await fetch('/send-pdf', {method: 'POST', body: formData});
                if (!res.ok) throw new Error('Email send failed');

                Swal.fire({
                    icon: 'success',
                    title: 'üéâ Submitted!',
                    text: 'Your PAR‚ÄëQ has been sent successfully.',
                    timer: 4000,
                    showConfirmButton: false
                });
                form.reset();
                currentStep = 0;
                showStep(currentStep);

            } catch (err) {
                console.error(err);
                Swal.fire({icon: 'error', title: 'Error', text: err.message});
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnHTML;
                document.body.removeChild(wrapper);
            }
        });
    });
</script>




<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Adventure Questionnaire</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />


  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

   body {
  background: url('/static/images/mourne-mountains-1.jpg') no-repeat center center fixed;
  background-size: cover;
  color: white;
}
   select.form-select.selected {
      border-color: #198754;
      box-shadow: 0 0 5px #198754;
    }

    .card {
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 8px;
    }

    .btn-success, .btn-secondary, .btn-primary {
      border: none;
    }

    .btn-success {
      background-color: #28a745;
    }
    .btn-success:hover {
      background-color: #218838;
    }

    .btn-primary {
      background-color: #007bff;
    }
    .btn-primary:hover {
      background-color: #0056b3;
    }

    .btn-secondary {
      background-color: #6c757d;
    }
    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .progress {
      background-color: rgba(255, 255, 255, 0.2);
      height: 20px;
    }

    .progress-bar {
      background-color: #28a745;
      line-height: 20px;
      color: white;
      font-weight: bold;
    }

    h2, h4, label {
      color: white;
    }
     select.form-select {
    color: black; /* Default when nothing selected */
    background-color: white;
  }
  select.form-select.selected {
    color: white;
    background-color: black;
  }
  @media print {
  body {
    background: none !important;
  }
}

  </style>
</head>
<body>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card p-4">
          <h2 class="text-center mb-3">Adventure Pre-Activity PAR-Q</h2>
          <div class="progress mb-4">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 33%;">Step 1 of 3</div>
          </div>
<form id="questionnaireForm" action="/send-pdf" method="POST" enctype="multipart/form-data">

            <!-- Step 1 -->
            <div class="form-step">
              <h4 class="mb-3">Medical History</h4>
              <p>Please answer the following YES/NO:</p>
              <div class="mb-2">1. Has your doctor ever indicated that you have heart trouble or high blood pressure?</div>
              <select class="form-select mb-3" name="q1" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <div class="mb-2">2. Have you ever been diagnosed with any chronic medical condition?</div>
              <select class="form-select mb-3" name="q2" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <div class="mb-2">3. Are you currently taking prescribed medication?</div>
              <select class="form-select mb-3" name="q3" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <div class="mb-2">4. Do you suffer from pains in your heart or chest or have chest pains brought on by
physical activity?</div>
              <select class="form-select mb-3" name="q4" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <div class="mb-2">5.Do you ever lose balance because of dizziness OR have you lost consciousness in the
last 12 months?</div>
              <select class="form-select mb-3" name="q5" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>

              <div class="mb-2">6.Has your doctors advised in the last 12 months that you should not take part in physical
activity? </div>
              <select class="form-select mb-3" name="q6" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              Note:  if you answer YES to any of the above questions then you are
advised to consult with your doctor before taking part in any activity to ensure that
it is safe for you to do so
              <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-success btn-next">Next</button>
              </div>
            </div>




            <!-- Step 2 -->
            <div class="form-step d-none">
              <h4 class="mb-3">Physical Capability</h4>
              <div class="mb-2">8.Do you have any bone or joint problems that could be aggravated by this
activity?</div>
              <select class="form-select mb-3" name="q8" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <div class="mb-2">9.Have you any current injuries that could impact your activity?</div>
              <select class="form-select mb-3" name="q9" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <div class="mb-2">10.Have you gone through surgery during last three months?</div>
              <select class="form-select mb-3" name="q10" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <div class="mb-2">11.Do you have diabetes? If yes, are you taking insulin?</div>
              <select class="form-select mb-3" name="q11" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <div class="mb-2">12. Do you have asthma, or exercise induced asthma?, if so are you required to
carry an inhaler? (Inhalers must be carried at all times, failure to do so will result in you not being able to take
part in the activity as Mourne Mountain Adventures cannot provide insurance to cover you.)</div>
              <select class="form-select mb-3" name="q12" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <div class="mb-2">13. Have you a fear of heights, or walking close to edges? </div>
              <select class="form-select mb-3" name="q13" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <div class="mb-2">14.Have you ever taken a stroke, or suffer from vertigo or epilepsy?</div>
              <select class="form-select mb-3" name="q14" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <div class="mb-2">15.Do you have any known allergies (medication, food, bee stings, plants, latex
or other source? </div>
              <select class="form-select mb-3" name="q15" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <div class="mb-2">16. Has your GP prescribed an EPI-Pen auto injector for emergency use? (If yes you must carry this item with you and advise the guide as to it‚Äôs location on
your person or ruck sack. ) </div>
              <select class="form-select mb-3" name="q16" required>
                <option value="">Select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary btn-prev">Previous</button>
                <button type="button" class="btn btn-success btn-next">Next</button>
              </div>
            </div>
 <!-- Step 3 -->
            <div class="form-step d-none">
              <h4 class="mb-3">Contact & Declaration</h4>
              <div class="mb-3">
                <label for="eventDate" class="form-label">Date of Event</label>
                <input type="date" id="eventDate" name="eventDate" class="form-control" required>
              </div>
              <div class="mb-3">
                <label for="mobile" class="form-label">Mobile Number</label>
                <input type="tel" id="mobile" name="mobile" class="form-control" required>
              </div>
              <div class="mb-3">
                <label for="emContact" class="form-label">Emergency Contact</label>
                <input type="text" id="emContact" name="emContact" class="form-control" placeholder="Name & Phone" required>
              </div>
              <div class="mb-3">
                <label for="participantName" class="form-label">Participant‚Äôs Name</label>
                <input type="text" id="participantName" name="participantName" class="form-control" placeholder="Name" required>
              </div>
              <div class="mb-3">
                <label for="formSubmissionDate" class="form-label">Date of Form Submission</label>
                <input type="date" id="formSubmissionDate" name="formSubmissionDate" class="form-control" required>
              </div>



              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="declaration1" name="declaration1" required>
                <label class="form-check-label" for="declaration1">
                  I provide authorisation for the R.E.C Outdoor First Aid trained guides to carry out first aid if required.
                </label>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="declaration2" name="declaration2" required>
                <label class="form-check-label" for="declaration2">
                  I release and discharge Mourne Mountain Adventures and their staff for any claim, injuries, losses, or liabilities from participation.
                </label>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="declaration3" name="declaration3" required>
                <label class="form-check-label" for="declaration3">
                  I declare that the information provided is accurate and I am fit to participate.
                </label>
              </div>

              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary btn-prev">Previous</button>
                  <button type="submit" id="submitBtn" class="btn btn-primary">Submit</button>
              </div>
                <!-- Message placeholder -->
<div id="formMessage" class="mt-3"></div>
            </div>
        </div>
      </div>
    </div>
  </div>
  </form> <!-- single closing form tag -->
</body>
<!-- include dependencies -->
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<form id="questionnaireForm">
  <!-- your existing fields here -->
  <input id="participantName" name="participantName" type="text" required>
  <input id="eventDate"     name="eventDate"     type="date" required>
  <!-- for each question: radio buttons or selects named q1, q2, ‚Ä¶ -->
  <button id="submitBtn" type="submit">Submit</button>
</form>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('questionnaireForm');
  const steps = Array.from(document.querySelectorAll('.form-step'));
  const progressBar = document.getElementById('progressBar');
  let current = 0;

  function showStep() {
    steps.forEach((step, i) => step.classList.toggle('d-none', i !== current));
    const pct = Math.round(((current + 1) / steps.length) * 100);
    progressBar.style.width = `${pct}%`;
    progressBar.innerText = `Step ${current + 1} of ${steps.length}`;
  }

  function validateStep() {
    const fields = Array.from(steps[current].querySelectorAll('input, select, textarea'));
    for (let f of fields) {
      if (f.required) {
        if ((f.type === 'checkbox' && !f.checked) ||
            (f.type !== 'checkbox' && !f.value.trim())) {
          const label = f.closest('.form-check')
                        ? f.nextElementSibling.innerText
                        : (f.previousElementSibling
                           ? f.previousElementSibling.innerText
                           : f.name);
          alert(`Please answer: ‚Äú${label.trim()}‚Äù before proceeding.`);
          return false;
        }
      }
    }
    return true;
  }

  // wire up Next/Prev
  steps.forEach((step, i) => {
    const next = step.querySelector('.btn-next');
    const prev = step.querySelector('.btn-prev');
    if (next) next.addEventListener('click', () => {
      if (!validateStep()) return;
      if (current < steps.length - 1) { current++; showStep(); }
    });
    if (prev) prev.addEventListener('click', () => {
      if (current > 0) { current--; showStep(); }
    });
  });

  // intercept final submit for PDF generation
  form.addEventListener('submit', async e => {
    e.preventDefault();
    if (!validateStep()) return;

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerText = 'Generating PDF‚Ä¶';

    try {
      // 1. fetch & load template
      const templateUrl = '/static/PAR-Q-Mourne-Mountain.pdf';
      const res = await fetch(templateUrl);
      if (!res.ok) throw new Error(`Template load failed: ${res.status}`);
      const bytes = await res.arrayBuffer();
      // sanity check PDF header
      if (new TextDecoder().decode(new Uint8Array(bytes,0,4)) !== '%PDF') {
        throw new Error('Template is not a PDF');
      }
      const pdfDoc = await PDFLib.PDFDocument.load(bytes);
      const page = pdfDoc.getPage(0);
      const { height } = page.getSize();
      const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

      // 2. gather data
      const name = form.participantName.value;
      const date = form.eventDate.value;
      const answers = {};
      for (let i = 1; i <= 16; i++) {
        const el = form.querySelector(`[name="q${i}"]`);
        answers[`q${i}`] = el ? el.value : '';
      }

      // 3. draw static fields (tweak x/y as needed)
      page.drawText(name, { x: 100, y: height - 150, size: 12, font });
      page.drawText(date, { x: 400, y: height - 150, size: 12, font });

      // 4. draw Yes/No checks for each question
      for (let i = 1; i <= 16; i++) {
        const ans = answers[`q${i}`].toLowerCase();
        const y = height - (180 + (i - 1) * 20);
        if (ans === 'yes') {
          page.drawText('‚úî', { x: 120, y, size: 14, font });
        } else if (ans === 'no') {
          page.drawText('‚úî', { x: 180, y, size: 14, font });
        }
      }

      // 5. serialize & POST
      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const fd = new FormData();
      fd.append('participantName', name);
      fd.append('eventDate', date);
      fd.append('file', blob, `${date}_${name}_PARQ.pdf`);
      fd.append('filename', `${date}_${name}_PARQ.pdf`);

      const postRes = await fetch('/send-pdf', { method: 'POST', body: fd });
      if (!postRes.ok) throw new Error('Server error on upload');

      await Swal.fire({
        icon: 'success',
        title: 'Submitted!',
        text: 'Your PAR‚ÄëQ has been generated and emailed.',
        timer: 3000,
        showConfirmButton: false
      });
      form.reset();
      current = 0;
      showStep();

    } catch (err) {
      console.error(err);
      Swal.fire({ icon: 'error', title: 'Error', text: err.message });
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerText = 'Submit';
    }
  });

  showStep();
});
</script>



</body>
</html>

@app.route('/send-pdf', methods=['POST'])
def send_existing_pdf():
    try:
        pdf_path = os.path.join('static', 'PAR‚ÄëQ‚ÄëMourne‚ÄëMountain.pdf')
        with open(pdf_path, 'rb') as f:
            pdf_data = f.read()

        msg = Message(
            subject="Mourne Mountain Adventures PAR-Q Form",
            recipients=["daniel@donite.com"],
            body="Attached is the standard PAR-Q form for Mourne Mountain Adventures."
        )
        msg.attach("PAR-Q Mourne Mountain Adventures.pdf", "application/pdf", pdf_data)
        mail.send(msg)

        return jsonify({'message': 'PDF sent successfully'}), 200

    except Exception as e:
        return jsonify({'error': str(e)}), 500